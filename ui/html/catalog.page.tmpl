{{define "main"}}
    <h2>Marketplace Management</h2>

    <article>
        <header><strong>Add New Category</strong></header>
        <form action="/category/add" method="POST" style="display: flex; gap: 10px;">
            <input type="text" name="name" placeholder="Category Name (e.g., Souvenirs)" required>
            <button type="submit">Create Category</button>
        </form>
    </article>

    <section style="margin: 20px 0; display: flex; gap: 15px;">
        <form action="/catalog" method="GET" style="display: flex; gap: 10px;">
            <input type="text" name="search" placeholder="Search products..." value="{{.SearchTerm}}">

            <select name="category">
                <option value="">All Categories</option>
                {{range .Categories}}
                    <option value="{{.ID.Hex}}">{{.Name}}</option>
                {{end}}
            </select>
            <div>
                <label for="city">Аймақ (Region):</label>
                <select name="city" id="city">
                    <option value="">Барлық аймақтар (All Regions)</option>
                    {{range .Cities}}
                        <option value="{{.}}">{{.}}</option>
                    {{end}}
                </select>
                <div>


            <button type="submit">Apply Filters</button>
        </form>
    </section>

    <section>
        <h3>Search Results</h3>
        <div class="product-grid">
            {{range .Products}}
                <div class="card">
                    <div class="card-header">
                        <strong>{{.Name}}</strong>
                        <span style="font-size: 0.7rem; background: #eee; padding: 2px 5px; border-radius: 3px; float: right;">
                            {{.City}}
                        </span>
                    </div>
                    <p>{{.Price}} ₸</p>
                    <div class="card-footer">
                        <a href="/product?id={{.ID.Hex}}" class="btn-primary">Көру</a>
                    </div>
                </div>
            {{else}}
                <div style="text-align: center; padding: 20px; border: 2px dashed #ccc;">
                    <p>No products found matching your search or category/city filter.</p>
                    <a href="/catalog">View All Products</a>
                </div>
            {{end}}
        </div>
    </section>

   {{if or .SearchTerm .CategoryName}}
       <div style="margin: 20px 0; padding: 15px; background-color: #e0f7fa; border-left: 5px solid #00afca; border-radius: 4px;">
           <p style="margin: 0;">
               Showing results for:
               {{if .SearchTerm}}<strong>"{{.SearchTerm}}"</strong>{{end}}
               {{if and .SearchTerm .CategoryName}} in {{end}}
               {{if .CategoryName}}<strong>{{.CategoryName}}</strong>{{end}}
           </p>
           <a href="/catalog" style="font-size: 0.85rem; text-decoration: underline;">Clear all filters</a>
       </div>
   {{end}}

    <article>
        <header><strong>Add New Product</strong></header>
        <form action="/product/create" method="POST">
            <input type="text" name="name" placeholder="Product Name" required>
            <input type="number" name="price" placeholder="Price (₸)" required>

            <div>
                <label for="city">Аймақ:</label>
                <select name="city" id="city">
                    <option value="">Барлық аймақтар (All Regions)</option>
                    {{range .Cities}}
                        <option value="{{.}}">{{.}}</option>
                    {{end}}
                </select>
            </div>

            <label>Category:</label>
            <select name="category_id" id="category-select" onchange="toggleNewCategory()">
                <option value="">-- Select Existing --</option>
                {{range .Categories}}
                    <option value="{{.ID.Hex}}">{{.Name}}</option>
                {{end}}
                <option value="NEW">Add New Category...</option>
            </select>

            <div id="new-category-div" style="display:none; margin-top: 10px;">
                <input type="text" name="new_category_name" placeholder="Enter New Category Name">
            </div>

            <button type="submit" style="margin-top: 15px;">Create Product</button>
        </form>
    </article>
    <script>
    function toggleNewCategory() {
        var select = document.getElementById("category-select");
        var div = document.getElementById("new-category-div");
        div.style.display = (select.value === "NEW") ? "block" : "none";
    }
    </script>
{{end}}